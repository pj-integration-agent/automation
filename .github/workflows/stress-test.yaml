name: JMeter Load Test

on:
  push:
    branches:
      - stress-test
  workflow_dispatch:

permissions:
  contents: write  # permite commits automáticos

jobs:
  load_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v3
        with:
          ref: stress-test

      - name: Instalar JMeter
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz

      - name: Criar diretórios de resultados
        run: mkdir -p results

      - name: Executar JMeter
        run: |
          apache-jmeter-5.6.3/bin/jmeter \
            -n \
            -t stress/stress-test.jmx \
            -l results/resultado.jtl \
            -e -o results/report

      - name: Gerar análise com IA (Groq) em TXT
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "Lendo JTL..."
          CONTENT=$(cat results/resultado.jtl)

          echo "Chamando Groq..."

          RESPONSE=$(curl -s https://api.groq.com/openai/v1/chat/completions \
            -H "Authorization: Bearer $GROQ_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"llama3-70b-8192\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"Você é especialista em análise de testes de carga do JMeter. Gere uma análise técnica detalhada em TEXTO PURO.\"
                },
                {
                  \"role\": \"user\",
                  \"content\": \"Analise o arquivo JTL abaixo e gere um relatório em texto contendo: resumo do teste, throughput, latência (p50, p90, p95, p99), erros, gargalos e recomendações:\n\n$CONTENT\"
                }
              ]
            }")

          echo "$RESPONSE" | jq -r '.choices[0].message.content' > stress/analise-ia.txt

      - name: Commit e push da análise
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add stress/analise-ia.txt
          git commit -m "Análise automática da IA (Groq)"
          git push origin stress-test
