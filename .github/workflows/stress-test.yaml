name: JMeter Load Test

on:
  push:
    branches:
      - stress-test
  workflow_dispatch:

jobs:
  load_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v3

      - name: Instalar JMeter
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz

      - name: Criar diretórios de resultados
        run: mkdir -p results

      - name: Executar JMeter
        run: |
          apache-jmeter-5.6.3/bin/jmeter \
            -n \
            -t stress/stress-test.jmx \
            -l results/resultado.jtl \
            -e -o results/report

      - name: Gerar análise com IA (HTML via Groq)
        run: |
          echo "Gerando relatório de análise com IA (GROQ)..."

          CONTENT=$(cat results/resultado.jtl)

          RESPONSE=$(curl -s https://api.groq.com/openai/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.GROQ_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"model\": \"llama3-70b-8192\",
                  \"messages\": [
                    {
                      \"role\": \"system\",
                      \"content\": \"Você é um engenheiro especialista em análise de testes de carga e stress. Gere um relatório HTML completo com tabelas, gráficos em SVG/HTML e recomendações técnicas sobre o desempenho do sistema.\"
                    },
                    {
                      \"role\": \"user\",
                      \"content\": \"Analise o seguinte arquivo JTL e gere um relatório final em HTML contendo: resumo do teste, latências (p50, p90, p95, p99), throughput, taxa de erro, endpoints problemáticos, gargalos encontrados e recomendações técnicas. Gere o HTML final agora:\n$CONTENT\"
                    }
                  ]
                }")

          echo "$RESPONSE" | jq -r '.choices[0].message.content' > results/analise-ia.html

      - name: Salvar relatórios como artefato
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report
          path: |
            results/report
            results/analise-ia.html
